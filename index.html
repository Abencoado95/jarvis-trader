<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>JARVIS TRADER</title>
    <link rel="icon" type="image/jpeg" href="JARVIS ROSTO.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { --neon-cyan: #00f3ff; --neon-red: #ff003c; --neon-green: #00ff41; --glass: rgba(10, 14, 18, 0.95); }
        * { box-sizing: border-box; outline: none; user-select: none; }
        body { background-color: #0d1117; color: white; font-family: 'Rajdhani', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; background: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000 100%); }
        
        /* LOGIN */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.95)), url('JARVIS ROSTO.jpg') center/cover no-repeat; }
        .login-content { text-align: center; backdrop-filter: blur(10px); padding: 50px; border-radius: 20px; border: 1px solid rgba(0, 243, 255, 0.2); background: rgba(0,0,0,0.7); box-shadow: 0 0 100px rgba(0,0,0,0.9); }
        .login-btn { background: rgba(0, 243, 255, 0.1); border: 2px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px 40px; font-size: 1.5rem; font-family: 'Rajdhani'; font-weight: 900; cursor: pointer; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); transition: 0.3s; text-transform: uppercase; letter-spacing: 3px; margin-top: 20px; }
        .login-btn:hover { background: var(--neon-cyan); color: #000; box-shadow: 0 0 50px var(--neon-cyan); }
        
        .interface-grid { display: none; grid-template-columns: 260px 1fr 280px; width: 98%; max-width: 1800px; height: 96vh; background: var(--glass); border: 1px solid rgba(0, 243, 255, 0.2); border-radius: 12px; position: relative; overflow: hidden; backdrop-filter: blur(15px); box-shadow: 0 0 100px rgba(0,0,0,0.5); }
        .sidebar-left, .sidebar-right { padding: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 10; background: rgba(0,0,0,0.3); }
        .sidebar-left { border-right: 1px solid rgba(255,255,255,0.05); } .sidebar-right { border-left: 1px solid rgba(255,255,255,0.05); }
        
        .brand-logo { font-size: 1.8rem; letter-spacing: 4px; color: var(--neon-cyan); border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 10px; font-weight: 900; text-align: center; text-shadow: 0 0 15px rgba(0, 243, 255, 0.6); }
        .brand-subtitle { font-size: 0.65rem; color: var(--neon-cyan); letter-spacing: 1px; text-transform: uppercase; margin-top: -10px; margin-bottom: 15px; text-align: center; font-weight: bold; text-shadow: 0 0 8px rgba(0, 243, 255, 0.8); }
        
        .config-group { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); }
        .label-sm { font-size: 0.75rem; color: #888; letter-spacing: 1px; font-weight: bold; margin-bottom: 5px; display: block; }
        input, select { background: #050505; color: #fff; border: 1px solid #333; padding: 8px; border-radius: 4px; font-family: 'Rajdhani'; font-size: 1.1rem; font-weight: bold; width: 100%; text-align: center; }
        
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 10px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--neon-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        .main-stage { padding: 15px; display: flex; flex-direction: column; gap: 15px; position: relative; width: 100%; background: radial-gradient(circle at center, rgba(0, 243, 255, 0.03) 0%, transparent 70%); }
        
        /* CHART & LAYOUT FIXES */
        .chart-wrapper { height: 55vh; flex-shrink: 0; position: relative; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
        #tvChart { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* JARVIS ANIMATION */
        .jarvis-container { position: absolute; top: 20px; left: 20px; width: 100px; height: 100px; z-index: 20; pointer-events: none; display: flex; justify-content: center; align-items: center; }
        .jarvis-img { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; border: 2px solid rgba(0,243,255,0.5); position: relative; z-index: 22; background: #000; }
        .energy-fog { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: 350px; background: radial-gradient(circle, rgba(0, 243, 255, 0.6) 0%, transparent 70%); opacity: 0; z-index: 21; pointer-events: none; mix-blend-mode: screen; border-radius: 50%; transition: opacity 0.3s; }
        .processing .energy-fog { animation: fogPulse 1s infinite ease-in-out; opacity: 1; }
        @keyframes fogPulse { 0% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.8); } 50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.8); } }
        
        .result-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 8rem; font-weight: 900; z-index: 30; opacity: 0; transition: all 0.4s; text-shadow: 0 0 50px currentColor; pointer-events: none; }
        .show-res { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        .btn-decode { width: 100%; padding: 15px; margin-top: 5px; background: linear-gradient(90deg, rgba(0,0,0,0.5), rgba(0, 243, 255, 0.15), rgba(0,0,0,0.5)); border: 1px solid var(--neon-cyan); color: var(--neon-cyan); font-family: 'Rajdhani'; font-size: 1.4rem; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.2; }
        .btn-decode:hover { background: rgba(0, 243, 255, 0.25); box-shadow: 0 0 30px rgba(0, 243, 255, 0.2); letter-spacing: 4px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 60px; }
        .btn-action { font-size: 1.8rem; font-weight: 900; border: none; color: white; cursor: pointer; border-radius: 6px; font-family: 'Rajdhani'; opacity: 0.6; }
        .btn-call { background: linear-gradient(180deg, #00ff85, #007a3d); box-shadow: 0 5px 0 #004522; }
        .btn-put { background: linear-gradient(180deg, #ff3b6a, #9e0025); box-shadow: 0 5px 0 #5c0016; }
        .btn-ready { opacity: 1; transform: translateY(0); }
        
        .positions-wrapper { flex: 1; min-height: 0; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; }
        .op-header { padding: 10px; background: rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .op-list { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 5px; }
        .op-card { display: flex; justify-content: space-between; padding: 10px; background: rgba(30,35,40,0.9); border-radius: 4px; border-left: 4px solid #555; align-items: center; font-size: 0.95rem; flex-shrink: 0; }
        
        .account-badge { background: #111; color: #fff; padding: 12px; text-align: center; border-radius: 6px; border: 1px solid #444; font-weight: bold; cursor: pointer; transition: 0.3s; margin-bottom: 15px; user-select: none; letter-spacing: 1px; }
        .account-badge:hover { border-color: var(--neon-cyan); color: var(--neon-cyan); box-shadow: 0 0 15px rgba(0,243,255,0.1); }
        .is-demo { color: #f1c40f; border-color: rgba(241, 196, 15, 0.5); }
        .is-real { color: #2ecc71; border-color: rgba(46, 204, 113, 0.5); }
        
        /* HARD RESET BUTTON */
        #hardResetBtn { position: fixed; bottom: 10px; right: 10px; z-index: 10000; background: red; color: white; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; opacity: 0.5; }
        #hardResetBtn:hover { opacity: 1; }
    </style>

    <div id="loginOverlay">
        <div class="login-content">
            <div class="brand-logo" style="font-size: 3rem; margin-bottom: 20px;">JARVIS TRADER</div>
            <button class="login-btn" onclick="connectDeriv()">INICIAR SISTEMA</button>
            <div style="margin-top: 20px; font-size: 0.8rem; color: #666;">V18.8 - STABLE MODE</div>
        </div>
    </div>

    <div class="interface-grid" id="mainUI">
        <div class="sidebar-left">
            <div class="brand-logo">JARVIS <span style="color:#fff">TRADER</span></div>
            <div class="brand-subtitle">CÓDIGO QUE ESCOLHE INTELIGÊNCIA QUE PROTEGE</div>
            <div id="accBadge" class="account-badge" onclick="switchAccount()">CARREGANDO...</div>
            
            <div class="config-group">
                <span class="label-sm">AUTO TRADER (IA)</span>
                <div class="switch-row">
                    <span style="font-size:0.8rem; color:#aaa;">PILOTO AUTOMÁTICO</span>
                    <label class="switch"><input type="checkbox" id="autoTradeToggle"><span class="slider"></span></label>
                </div>
            </div>
            <div class="config-group">
                <span class="label-sm">STAKE ($)</span>
                <input type="number" id="stakeInput" value="1.00" step="0.50" min="0.35">
            </div>
            <div class="config-group">
                <span class="label-sm">EXPIRAÇÃO</span>
                <select id="durationSelect">
                    <option value="1">1 Minuto</option>
                    <option value="2">2 Minutos</option>
                    <option value="5">5 Minutos</option>
                </select>
            </div>
            <div class="config-group">
                <span class="label-sm" style="color:var(--neon-green)">TAKE PROFIT</span>
                <input type="number" id="tpInput" value="10.00" step="0.05">
                <div class="switch-row">
                    <span style="font-size:0.7rem;">AUTO FECHAR</span>
                    <label class="switch"><input type="checkbox" id="tpToggle"><span class="slider"></span></label>
                </div>
            </div>
            <div class="config-group" style="border-color: rgba(255,0,60,0.3);">
                <span class="label-sm" style="color:var(--neon-red)">STOP LOSS</span>
                <input type="number" id="slInput" value="-20.00" style="color:var(--neon-red)" step="0.05">
                <div class="switch-row">
                    <span style="font-size:0.7rem;">PROTEÇÃO</span>
                    <label class="switch"><input type="checkbox" id="slToggle"><span class="slider"></span></label>
                </div>
            </div>
            <div style="margin-top:auto; font-size:0.9rem; border-top:1px solid #333; padding-top:10px;">
                <div class="status-row" style="display:flex; justify-content:space-between;"><span>RSI (14)</span><span id="rsiVal" style="font-weight:bold; color:#fff;">--</span></div>
                <div class="status-row" style="font-size:1.4rem; color:var(--neon-cyan); margin-top:10px; font-weight:900; text-align:right;">
                    <span id="balanceVal">--</span>
                </div>
            </div>
        </div>
        <div class="main-stage">
            <div class="chart-wrapper" id="chartContainer">
                <div id="tvChart"></div>
                <div class="jarvis-container" id="jarvisAnim">
                    <div class="energy-fog"></div>
                    <img src="jarvis.gif" class="jarvis-img" onerror="this.style.display='none'">
                </div>
                <div class="live-price" id="priceTag">--.--</div>
                <div class="result-overlay" id="resultBig">CALL</div>
            </div>
            <button class="btn-decode" id="btnDecode" onclick="runAI()">
                <span>DECODIFICAR MERCADO</span>
                <span style="font-size:0.8rem; color:#00ff41; margin-top:5px; text-shadow:0 0 10px #00ff41; letter-spacing:1px;">JARVIS ONLINE</span>
            </button>
            <div class="action-grid">
                <button class="btn-action btn-call" id="btnCall" onclick="placeTrade('CALL')" disabled>CALL ⬆</button>
                <button class="btn-action btn-put" id="btnPut" onclick="placeTrade('PUT')" disabled>PUT ⬇</button>
            </div>
            <div class="positions-wrapper">
                <div class="op-header">
                    <span style="font-size:0.8rem; font-weight:bold;">LUCRO ABERTO: <span id="openPL" style="color:#fff;">0.00</span></span>
                    <button onclick="closeAllPositions()" style="background:#ff003c; border:none; color:white; font-weight:bold; cursor:pointer; padding:4px 10px; font-size:0.7rem; border-radius:3px;">FECHAR TUDO</button>
                </div>
                <div class="op-list" id="posList">
                    <div style="text-align:center; color:#555; padding:20px; font-style:italic;">Nenhuma operação ativa.</div>
                </div>
            </div>
        </div>
        <div class="sidebar-right">
            <div style="background:rgba(255,255,255,0.03); padding:20px; border-radius:8px; text-align:center; border:1px solid #333;">
                <div style="font-size:0.8rem; color:#888; letter-spacing:2px;">RESULTADO DO DIA</div>
                <div id="sessionPL" style="font-size:2.5rem; font-weight:900; margin-top:5px; color:white;">0.00</div>
            </div>
            <div style="border-bottom:1px solid #333; padding-bottom:5px; margin-top:20px;">
                <span class="label-sm">HISTÓRICO RECENTE</span>
            </div>
            <div id="histList" style="flex:1; overflow-y:auto; padding-right:5px;">
                <div style="text-align:center; color:#444; font-size:0.8rem; margin-top:30px;">Histórico vazio.</div>
            </div>
            <button onclick="fullLogout()" style="background:transparent; border:1px solid #444; color:#666; padding:12px; cursor:pointer; width:100%; border-radius:4px; font-weight:bold; transition:0.2s;">SAIR DA CONTA</button>
        </div>
    </div>
    
    <button id="hardResetBtn" onclick="fullLogout()">HARD RESET</button>

<script>
    // --- HELPER DE SEGURANÇA MÁXIMA ---
    function getEl(id) {
        const el = document.getElementById(id);
        if (!el) {
            console.warn(`CRITICAL: Elemento #${id} não encontrado! Criando dummy...`);
            const dummy = document.createElement('div');
            // Retorna dummy para evitar crash de .style ou .innerText
            return dummy;
        }
        return el;
    }

    // --- GLOBAL ERROR HANDLER ---
    window.onerror = function(msg, url, line) {
        if(localStorage.getItem('crash_loop_guard')) return;
        localStorage.setItem('crash_loop_guard', 'true');
        alert("RECUPERAÇÃO DE FALHA V18.8:\\n" + msg);
        localStorage.removeItem('jarvis_accounts');
        setTimeout(() => {
            localStorage.removeItem('crash_loop_guard');
            location.reload(true);
        }, 500);
        return true;
    };

    const APP_ID = 114062; 
    const SYMBOL = "1HZ100V";
    
    window.connectDeriv = function() {
        window.location.href = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=pt&brand=deriv`;
    }
    
    let ws;
    let chart, series;
    let candles = [];
    let model = null;
    let isProcessing = false;
    let availableAccounts = [];
    let currentToken = "";
    let positions = new Map();
    let sessionProfit = 0.0;

    // BOOT SEGURO
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Loaded. Iniciando Jarvis V18.8...");
        try {
            checkAuth();
        } catch(e) {
            console.error("Boot Error:", e);
            getEl('loginOverlay').style.display = 'flex';
        }
    });

    function checkAuth() {
        const p = new URLSearchParams(window.location.search);
        if (p.has('token1')) {
            let i = 1;
            let accs = [];
            while (p.has(`token${i}`)) {
                accs.push({ 
                    token: p.get(`token${i}`), 
                    id: p.get(`acct${i}`), 
                    currency: p.get(`cur${i}`), 
                    type: p.get(`acct${i}`).startsWith('V') ? 'DEMO' : 'REAL' 
                });
                i++;
            }
            localStorage.setItem('jarvis_accounts', JSON.stringify(accs));
            window.history.replaceState({}, document.title, window.location.pathname);
            availableAccounts = accs;
            currentToken = accs[0].token;
            initSystem();
        } else {
            const saved = localStorage.getItem('jarvis_accounts');
            if (saved) {
                try {
                    availableAccounts = JSON.parse(saved);
                    if (Array.isArray(availableAccounts) && availableAccounts.length > 0) {
                        currentToken = availableAccounts[0].token;
                        initSystem();
                    } else {
                        throw new Error("Dados inválidos");
                    }
                } catch(e) {
                    localStorage.removeItem('jarvis_accounts');
                    getEl('loginOverlay').style.display = 'flex';
                }
            } else {
                getEl('loginOverlay').style.display = 'flex';
            }
        }
    }

    function initSystem() {
        getEl('loginOverlay').style.display = 'none';
        getEl('mainUI').style.display = 'grid';
        setTimeout(() => {
            initChart();
            loadAI();
            connectWS();
        }, 100);
    }

    function fullLogout() {
        localStorage.removeItem('jarvis_accounts');
        location.href = location.pathname;
    }

    function switchAccount() {
        if (!availableAccounts.length) return;
        const currIdx = availableAccounts.findIndex(a => a.token === currentToken);
        const nextIdx = (currIdx + 1) % availableAccounts.length;
        const nextAcc = availableAccounts[nextIdx];
        currentToken = nextAcc.token;
        if(ws) ws.close();
        getEl('accBadge').innerText = "TROCANDO...";
        setTimeout(connectWS, 500);
    }

    function updateAccountUI(info) {
        const badge = getEl('accBadge');
        const isDemo = info.fullname.includes('Virtual') || info.loginid.startsWith('VRTC');
        if(isDemo) {
            badge.innerText = `MODO TREINO (DEMO)`;
            badge.className = "account-badge is-demo";
        } else {
            badge.innerText = `CONTA REAL (${info.currency})`;
            badge.className = "account-badge is-real";
        }
        getEl('btnCall').disabled = false;
        getEl('btnPut').disabled = false;
        getEl('btnCall').classList.add('btn-ready');
        getEl('btnPut').classList.add('btn-ready');
    }

    function initChart() {
        const el = getEl('tvChart');
        const container = getEl('chartContainer');
        
        el.innerHTML = '';
        chart = LightweightCharts.createChart(el, {
            width: container.clientWidth, 
            height: container.clientHeight,
            layout: { backgroundColor: '#000000', textColor: '#666' },
            grid: { vertLines: { color: '#111'}, horzLines: { color: '#111'} },
            timeScale: { timeVisible: true, secondsVisible: true }
        });
        series = chart.addCandlestickSeries({
            upColor: '#00ff41', downColor: '#ff003c', 
            borderVisible: false, wickUpColor: '#00ff41', wickDownColor: '#ff003c'
        });
        new ResizeObserver(entries => {
            if (entries.length === 0 || !entries[0].contentRect) return;
            const { width, height } = entries[0].contentRect;
            chart.resize(width, height);
        }).observe(container);
    }

    function connectWS() {
        ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);
        ws.onopen = () => { ws.send(JSON.stringify({ authorize: currentToken })); };
        ws.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            
            // ERROR HANDLING
            if (data.error) {
                console.error("Deriv Error:", data.error);
                // Feedback visual sutil
                const btn = getEl('btnDecode');
                const old = btn.innerHTML;
                btn.innerHTML = `<span style="color:red">ERRO: ${data.error.code}</span>`;
                setTimeout(() => btn.innerHTML = old, 3000);
                return;
            }

            if (data.msg_type === 'authorize') {
                updateAccountUI(data.authorize);
                ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                ws.send(JSON.stringify({ ticks_history: SYMBOL, adjust_start_time: 1, count: 300, end: 'latest', style: 'candles', granularity: 60, subscribe: 1 }));
                ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
            }
            if (data.msg_type === 'balance') getEl('balanceVal').innerText = data.balance.balance + " " + data.balance.currency;
            if (data.msg_type === 'ohlc') {
                const c = data.ohlc;
                updateCandles({ time: c.open_time, open: +c.open, high: +c.high, low: +c.low, close: +c.close });
            }
            if (data.msg_type === 'candles') {
                candles = data.candles.map(c => ({ time: c.epoch, open: +c.open, high: +c.high, low: +c.low, close: +c.close }));
                if(series) series.setData(candles);
            }
            if (data.msg_type === 'proposal') {
                if (data.proposal.id) ws.send(JSON.stringify({ buy: data.proposal.id, price: data.proposal.ask_price }));
            }
            if (data.msg_type === 'proposal_open_contract') handlePosition(data.proposal_open_contract);
        };
    }

    function updateCandles(candle) {
        if (candles.length > 0 && candles[candles.length - 1].time === candle.time) candles[candles.length - 1] = candle;
        else { candles.push(candle); if(candles.length > 300) candles.shift(); }
        if(series) series.update(candle);
        const priceEl = getEl('priceTag');
        priceEl.innerText = candle.close;
        priceEl.style.color = candle.close >= candle.open ? '#00ff41' : '#ff003c';
        updateRSI();
    }

    function updateRSI() {
        if(candles.length < 15) return;
        const period = 14;
        let gains = 0, losses = 0;
        const closes = candles.slice(-period-1).map(x=>x.close);
        for(let i=1; i<=period; i++) {
            const diff = closes[i] - closes[i-1];
            if(diff >= 0) gains += diff; else losses -= diff;
        }
        const rs = gains / (losses || 1);
        const rsi = 100 - (100 / (1 + rs));
        getEl('rsiVal').innerText = rsi.toFixed(1);
    }

    async function loadAI() {
        console.log("Carregando IA...");
        try {
            model = await tf.loadLayersModel('brain/titan.json');
            const dummy = tf.zeros([1, 60, 1]);
            model.predict(dummy).dispose();
            console.log("IA Online");
        } catch (e) {
            console.error("Erro IA:", e);
        }
    }

    // --- HYBRID INTELLIGENCE ENGINE ---
    async function runAI() {
        if (isProcessing) return;
        
        const btn = getEl('btnDecode');
        const originalContent = btn.innerHTML;

        if (candles.length < 30) { 
            btn.innerHTML = "<span>AGUARDANDO DADOS...</span>";
            setTimeout(() => btn.innerHTML = originalContent, 1500);
            return; 
        }
        
        isProcessing = true;
        getEl('jarvisAnim').classList.add('processing'); 
        btn.innerHTML = "<span>ANALISANDO...</span>";
        
        // REMOVIDO AUTO ZOOM A PEDIDO DO USUÁRIO
        // if(chart) chart.timeScale().scrollToPosition(0, true);

        try {
            // 1. Tenta usar LSTM se disponível
            let signal = "NEUTRO";
            let source = "TÉCNICA";

            if (model && candles.length >= 60) {
                try {
                    const inputData = candles.slice(-60).map(c => c.close);
                    const mean = inputData.reduce((a, b) => a + b) / inputData.length;
                    const variance = inputData.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / inputData.length;
                    const std = Math.sqrt(variance) || 1;
                    const normData = inputData.map(val => (val - mean) / std);
                    const tensor = tf.tensor3d([normData], [1, 60, 1]);
                    const prediction = model.predict(tensor).dataSync()[0];
                    tensor.dispose();
                    
                    if (prediction > 0.60) { signal = "CALL"; source = "IA LSTM"; }
                    else if (prediction < 0.40) { signal = "PUT"; source = "IA LSTM"; }
                } catch(e) {
                    console.warn("LSTM falhou, usando fallback técnico.");
                }
            }

            // 2. Fallback para Análise Técnica (RSI + Tendência) se LSTM não deu sinal
            if (signal === "NEUTRO") {
                const last = candles[candles.length-1];
                const prev = candles[candles.length-2];
                const rsi = parseFloat(getEl('rsiVal').innerText);
                
                // Estratégia de Reversão Simples
                if (rsi < 30 && last.close > last.open) signal = "CALL"; // Sobrevenda + Candle Verde
                else if (rsi > 70 && last.close < last.open) signal = "PUT"; // Sobrecompra + Candle Vermelho
                // Estratégia de Tendência
                else if (last.close > prev.close && rsi > 50 && rsi < 70) signal = "CALL";
                else if (last.close < prev.close && rsi < 50 && rsi > 30) signal = "PUT";
            }

            setTimeout(() => {
                showResult(signal);
                
                // AUTO TRADER TRIGGER
                if(signal !== "NEUTRO" && getEl('autoTradeToggle').checked) {
                    console.log(`Auto Trader Triggered: ${signal} via ${source}`);
                    placeTrade(signal);
                }

                isProcessing = false;
                getEl('jarvisAnim').classList.remove('processing');
                btn.innerHTML = originalContent;
            }, 2000); 

        } catch(e) { 
            console.error("Critical Analysis Error:", e);
            isProcessing = false; 
            getEl('jarvisAnim').classList.remove('processing');
            btn.innerHTML = originalContent;
        }
    }

    function showResult(text) {
        const el = getEl('resultBig');
        el.innerText = text;
        el.style.color = text === "CALL" ? "#00ff41" : (text === "PUT" ? "#ff003c" : "#fff");
        el.classList.add('show-res');
        setTimeout(() => el.classList.remove('show-res'), 3000);
    }

    function placeTrade(direction) {
        const stake = parseFloat(getEl('stakeInput').value);
        const duration = getEl('durationSelect').value;
        const acc = availableAccounts.find(a=>a.token===currentToken);
        
        if(!acc) {
            console.error("Conta não encontrada!");
            return;
        }
        
        // Feedback visual de ordem enviada
        const btn = direction === 'CALL' ? getEl('btnCall') : getEl('btnPut');
        const originalColor = btn.style.background;
        btn.style.filter = "brightness(1.5)";
        setTimeout(() => btn.style.filter = "none", 500);

        ws.send(JSON.stringify({ 
            proposal: 1, 
            amount: stake, 
            basis: 'stake', 
            contract_type: direction, 
            currency: acc.currency, 
            duration: duration, 
            duration_unit: 'm', 
            symbol: SYMBOL 
        }));
    }

    function handlePosition(p) {
        if (p.is_sold) {
            if (positions.has(p.contract_id)) { positions.delete(p.contract_id); addHistory(p); ws.send(JSON.stringify({ balance: 1 })); }
        } else {
            positions.set(p.contract_id, p);
            const profit = Number(p.profit || 0);
            const tp = Number(getEl('tpInput').value);
            const sl = Number(getEl('slInput').value) * -1; // SL é negativo
            if (p.is_valid_to_sell) {
                if (getEl('tpToggle').checked && profit >= tp) sellPosition(p.contract_id);
                if (getEl('slToggle').checked && profit <= sl) sellPosition(p.contract_id);
            }
        }
        renderPositions();
    }

    function sellPosition(id) { ws.send(JSON.stringify({ sell: id, price: 0 })); }
    function closeAllPositions() { positions.forEach((_, id) => sellPosition(id)); }

    function renderPositions() {
        const list = getEl('posList');
        list.innerHTML = "";
        let total = 0;
        if(positions.size === 0) list.innerHTML = '<div style="text-align:center; color:#555; padding:20px; font-style:italic;">Nenhuma operação ativa.</div>';
        
        positions.forEach(p => {
            const profit = Number(p.profit || 0);
            total += profit;
            const cType = p.contract_type ? p.contract_type.toUpperCase() : "ORDEM";
            const div = document.createElement('div');
            div.className = "op-card";
            div.style.borderLeftColor = profit >= 0 ? "#00ff41" : "#ff003c";
            div.innerHTML = `<div><b>${cType}</b></div><div style="color:${profit>=0?'#00ff41':'#ff003c'}">${profit.toFixed(2)}</div><button onclick="sellPosition(${p.contract_id})" style="background:#ff003c; border:none; color:white; font-weight:bold; cursor:pointer;">X</button>`;
            list.prepend(div);
        });
        getEl('openPL').innerText = total.toFixed(2);
        getEl('openPL').style.color = total >= 0 ? "#00ff41" : "#ff003c";
    }

    function addHistory(p) {
        sessionProfit += Number(p.profit || 0);
        getEl('sessionPL').innerText = sessionProfit.toFixed(2);
        getEl('sessionPL').style.color = sessionProfit >= 0 ? "#00ff41" : "#ff003c";
        const div = document.createElement('div');
        div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #333; font-size:0.85rem;";
        div.innerHTML = `<span style="color:${p.contract_type==='CALL'?'#00ff41':'#ff003c'}">${p.contract_type}</span><span style="font-weight:bold; color:${Number(p.profit)>=0?'#00ff41':'#ff003c'}">${Number(p.profit).toFixed(2)}</span>`;
        const h = getEl('histList');
        if(h.innerText.includes("vazio")) h.innerHTML = "";
        h.prepend(div);
    }
</script>
</body>
</html>