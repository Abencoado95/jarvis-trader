<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>JARVIS COMMAND CENTER V21.19</title>
    <link rel="icon" type="image/jpeg" href="JARVIS ROSTO.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { 
            --cyber-dark: #050a14;
            --cyber-navy: #0b1221;
            --cyber-blue: #00f3ff;
            --cyber-gold: #ffd700;
            --cyber-red: #ff003c;
            --cyber-green: #00ff41;
            --glass-panel: rgba(11, 18, 33, 0.85);
            --glass-border: 1px solid rgba(0, 243, 255, 0.15);
            --neon-glow: 0 0 10px rgba(0, 243, 255, 0.3);
        }
        
        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body { 
            background: radial-gradient(circle at 50% 50%, #0b1629 0%, #020408 100%);
            color: #e0e6ed; 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }

        /* AUTO-SCALE REMOVED - FLUID LAYOUT IMPLEMENTED */
        
        /* LOGIN OVERLAY */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: rgba(5, 10, 20, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .login-content { 
            text-align: center; 
            padding: 60px; 
            border-radius: 4px; 
            border: 1px solid var(--cyber-blue); 
            background: rgba(0,0,0,0.6); 
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1); 
            position: relative;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .login-content::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, var(--cyber-blue), transparent, var(--cyber-blue));
            z-index: -1; opacity: 0.3;
        }

        .login-avatar {
            width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--cyber-blue);
            box-shadow: 0 0 30px rgba(0,243,255,0.3); margin-bottom: 20px; object-fit: cover;
        }

        .login-btn { 
            background: transparent; 
            border: 2px solid var(--cyber-blue); 
            color: var(--cyber-blue); 
            padding: 15px 50px; 
            font-size: 1.5rem; 
            font-family: 'Rajdhani'; 
            font-weight: 800; 
            cursor: pointer; 
            transition: 0.3s; 
            text-transform: uppercase; 
            letter-spacing: 4px; 
            margin-top: 30px; 
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover { 
            background: var(--cyber-blue); 
            color: #000; 
            box-shadow: 0 0 30px var(--cyber-blue); 
        }

        /* RESPONSIVE GRID INTERFACE */
        .interface-grid { 
            display: grid; 
            grid-template-columns: 320px 1fr 320px; 
            width: 100vw; 
            height: 100vh; 
            background: var(--glass-panel); 
            overflow: hidden; 
            backdrop-filter: blur(20px); 
        }
        
        .sidebar-left, .sidebar-right { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            z-index: 10; 
            background: rgba(0,0,0,0.2); 
            overflow-y: auto; /* SCROLLABLE SIDEBARS */
            height: 100%;
        }
        
        .sidebar-left { border-right: var(--glass-border); } 
        .sidebar-right { border-left: var(--glass-border); }
        
        .main-stage { 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            position: relative; 
            width: 100%; 
            height: 100%;
            overflow-y: auto;
            background: radial-gradient(circle at center, rgba(0, 243, 255, 0.02) 0%, transparent 80%); 
        }

        /* MOBILE RESPONSIVE TWEAKS */
        @media (max-width: 1200px) {
            .interface-grid {
                grid-template-columns: 1fr; /* Stack vertically */
                grid-template-rows: auto auto auto;
                overflow-y: auto; /* Allow full page scroll */
            }
            .sidebar-left { order: 2; height: auto; border-right: none; border-bottom: var(--glass-border); }
            .sidebar-right { order: 3; height: auto; border-left: none; }
            .main-stage { order: 1; height: auto; border-bottom: var(--glass-border); min-height: 100vh; }
            #tvChart { height: 400px; }
        }
        
        .brand-logo { 
            font-size: 2rem; 
            letter-spacing: 4px; 
            color: var(--cyber-blue); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 15px;
            margin-bottom: 5px; 
            font-weight: 900; 
            text-align: center; 
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.4); 
        }
        
        .brand-subtitle { 
            font-size: 0.7rem; 
            color: #8899a6; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
            margin-bottom: 15px; 
            text-align: center; 
            font-weight: 600; 
        }
        
        /* CONFIG GROUPS */
        .config-group { 
            background: rgba(255,255,255,0.02); 
            padding: 15px; 
            border-radius: 2px; 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: 0.3s;
        }
        .config-group:hover { border-color: rgba(0, 243, 255, 0.3); }
        
        .label-sm { 
            font-size: 0.8rem; 
            color: #5f7e97; 
            letter-spacing: 1px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            display: block; 
            text-transform: uppercase;
        }
        
        input, select { 
            background: #080c14; 
            color: #fff; 
            border: 1px solid #2a3b55; 
            padding: 10px; 
            border-radius: 2px; 
            font-family: 'Rajdhani'; 
            font-size: 1.1rem; 
            font-weight: 700; 
            width: 100%; 
            text-align: center; 
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--cyber-blue); box-shadow: 0 0 15px rgba(0,243,255,0.1); }
        
        /* SWITCHES */
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .switch { position: relative; display: inline-block; width: 45px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a2639; transition: .4s; border-radius: 2px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: #5f7e97; transition: .4s; border-radius: 1px; }
        input:checked + .slider { background-color: rgba(0, 255, 65, 0.2); border: 1px solid var(--cyber-green); }
        input:checked + .slider:before { transform: translateX(21px); background-color: var(--cyber-green); }
        
        /* CHART */
        .chart-wrapper { 
            height: 400px; /* Fixed height for chart */
            min-height: 300px;
            flex-shrink: 0; 
            position: relative; 
            background: #050a14; 
            border: 1px solid #1a2639; 
            border-radius: 2px; 
            overflow: hidden; 
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9); 
        }
        #tvChart { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* JARVIS VISUALS */
        .jarvis-container { 
            position: absolute; top: 20px; left: 20px; width: 120px; height: 120px; z-index: 20; 
            pointer-events: none; display: flex; justify-content: center; align-items: center; 
        }
        
        .jarvis-img { 
            width: 100px; height: 100px; object-fit: cover; border-radius: 50%; 
            position: relative; z-index: 22; background: #000; 
            border: 2px solid rgba(0,243,255,0.3); 
        }
        
        .neon-ring { 
            position: absolute; width: 110px; height: 110px; border-radius: 50%; 
            border: 2px dashed var(--cyber-blue); border-top-color: transparent; border-bottom-color: transparent; 
            z-index: 21; 
            animation: spinSlow 10s linear infinite; 
            box-shadow: 0 0 15px rgba(0,243,255,0.2); 
            transition: all 0.5s ease;
        }
        
        .energy-wave {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 300px; 
            background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%);
            opacity: 0; z-index: 10; pointer-events: none;
            border-radius: 50%;
            animation: wavePulse 2s infinite ease-out;
            transition: background 0.5s ease; 
        }

        .sentiment-bullish .energy-wave { background: radial-gradient(circle, rgba(0, 255, 65, 0.3) 0%, transparent 70%); }
        .sentiment-bullish .neon-ring { border-color: var(--cyber-green); box-shadow: 0 0 20px rgba(0,255,65,0.3); }
        
        .sentiment-bearish .energy-wave { background: radial-gradient(circle, rgba(255, 0, 60, 0.3) 0%, transparent 70%); }
        .sentiment-bearish .neon-ring { border-color: var(--cyber-red); box-shadow: 0 0 20px rgba(255,0,60,0.3); }
        
        .sentiment-neutral .energy-wave { background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%); }
        .sentiment-neutral .neon-ring { border-color: var(--cyber-blue); box-shadow: 0 0 15px rgba(0,243,255,0.2); }

        @keyframes spinSlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes wavePulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        /* BUTTONS */
        .btn-decode { 
            width: 100%; padding: 20px; margin-top: 5px; 
            background: linear-gradient(90deg, rgba(0,0,0,0.8), rgba(0, 243, 255, 0.1), rgba(0,0,0,0.8)); 
            border: 1px solid var(--cyber-blue); 
            color: var(--cyber-blue); 
            font-family: 'Rajdhani'; font-size: 1.8rem; font-weight: 900; 
            letter-spacing: 4px; text-transform: uppercase; 
            cursor: pointer; transition: 0.3s; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            line-height: 1.2; 
            position: relative;
        }
        .btn-decode::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--cyber-blue); box-shadow: 0 0 20px var(--cyber-blue);
        }
        .btn-decode:hover { background: rgba(0, 243, 255, 0.15); letter-spacing: 6px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 70px; }
        .btn-action { 
            font-size: 1.8rem; font-weight: 900; border: none; color: white; 
            cursor: pointer; border-radius: 2px; font-family: 'Rajdhani'; opacity: 0.4; 
            transition: 0.3s; letter-spacing: 2px;
        }
        .btn-call { background: linear-gradient(180deg, #00ff85, #004d26); border-bottom: 4px solid #004d26; }
        .btn-put { background: linear-gradient(180deg, #ff3b6a, #5e0018); border-bottom: 4px solid #5e0018; }
        .btn-ready { opacity: 1; }
        .btn-ready:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        /* POSITIONS TABLE SCROLLABLE */
        .positions-wrapper { 
            flex: 1; 
            min-height: 200px;
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 2px; display: flex; flex-direction: column;
            overflow: hidden; /* Contains the scroll */
        }
        .op-header { 
            padding: 12px; background: rgba(255,255,255,0.02); 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        
        .table-scroll { flex: 1; overflow-y: auto; } /* SCROLL CONTAINER */

        .pos-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .pos-table th { text-align: left; padding: 10px; color: #5f7e97; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; background: #0b1629; z-index: 5; }
        .pos-table td { padding: 10px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 600; }
        .pos-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .result-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 6rem; font-weight: 900; z-index: 30; opacity: 0; transition: all 0.4s; text-shadow: 0 0 50px currentColor; pointer-events: none; }
        .show-res { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        
        /* ACCOUNT BADGE */
        .account-badge { 
            background: rgba(0,0,0,0.4); color: #fff; padding: 15px; text-align: center; 
            border-radius: 2px; border: 1px solid #333; font-weight: 800; 
            cursor: pointer; transition: 0.3s; 
            user-select: none; letter-spacing: 2px; font-size: 0.9rem;
        }
        .account-badge:hover { border-color: var(--cyber-blue); color: var(--cyber-blue); box-shadow: 0 0 20px rgba(0,243,255,0.1); }
        .is-demo { color: var(--cyber-gold); border-color: rgba(255, 215, 0, 0.3); }
        .is-real { color: var(--cyber-green); border-color: rgba(0, 255, 65, 0.3); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050a14; }
        ::-webkit-scrollbar-thumb { background: #2a3b55; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyber-blue); }

        #hardResetBtn { position: fixed; bottom: 10px; right: 10px; z-index: 10000; background: var(--cyber-red); color: white; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; opacity: 0.3; }
        #hardResetBtn:hover { opacity: 1; }
    </style>

    <div id="loginOverlay">
        <div class="login-content">
            <img src="JARVIS ROSTO.jpg" class="login-avatar" onerror="this.src='jarvis.gif'">
            <div class="brand-logo" style="font-size: 3.5rem; margin-bottom: 30px;">JARVIS V21.21</div>
            <div style="color:#8899a6; letter-spacing:2px; margin-bottom:30px;">ACTIVE SCALPING // HYBRID</div>
            <button class="login-btn" onclick="connectDeriv()">INICIAR SISTEMA</button>
        </div>
    </div>

    <!-- RESPONSIVE GRID -->
    <div class="interface-grid" id="mainUI">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar-left">
            <div class="brand-logo">JARVIS <span style="color:#fff">V20</span></div>
            <div class="brand-subtitle">C√ìDIGO QUE ESCOLHE INTELIG√äNCIA QUE PROTEGE</div>
            <div id="accBadge" class="account-badge" onclick="switchAccount()">CARREGANDO...</div>
            
            <div style="border:1px solid rgba(0,243,255,0.3); padding:15px; border-radius:2px; background:rgba(0,0,0,0.3);">
                <div style="font-size:0.8rem; color:#5f7e97; letter-spacing:2px; margin-bottom:5px; text-align:center;">SALDO DA CONTA</div>
                <div id="balanceVal" style="font-size:2.5rem; color:var(--cyber-blue); font-weight:900; text-align:center; text-shadow:0 0 20px rgba(0,243,255,0.4);">--</div>
            </div>
            
            <div class="config-group">
                <span class="label-sm">AUTO PILOT (CHRONOS)</span>
                <div class="switch-row">
                    <span style="font-size:1rem; color:#fff; font-weight:bold;">MODO AUTOM√ÅTICO</span>
                    <label class="switch"><input type="checkbox" id="autoTradeToggle" onchange="saveState()"><span class="slider"></span></label>
                </div>
            </div>
            <div class="config-group">
                <span class="label-sm">STAKE ($)</span>
                <input type="number" id="stakeInput" value="1.00" step="0.50" min="0.35" onchange="saveState()">
            </div>
            <div class="config-group">
                <span class="label-sm">EXPIRA√á√ÉO (SEGURAN√áA)</span>
                <select id="durationSelect" onchange="saveState()">
                    <option value="60">1 Hora (Recomendado)</option>
                    <option value="30">30 Minutos</option>
                    <option value="15">15 Minutos</option>
                    <option value="5">5 Minutos</option>
                    <option value="1">1 Minuto (Arriscado)</option>
                </select>
            </div>
            <div class="config-group">
                <span class="label-sm" style="color:var(--cyber-gold)">TAKE PROFIT % (POR ORDEM)</span>
                <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">Fecha ao atingir % de lucro:</div>
                <input type="number" id="scalpPercent" value="10" step="1" min="1" max="100" onchange="saveState()" style="color:var(--cyber-gold)">
            </div>
            <div class="config-group" style="border-color:rgba(255,0,60,0.3);">
                <span class="label-sm" style="color:var(--cyber-red)">STOP LOSS % (POR ORDEM)</span>
                <div style="font-size:0.7rem; color:#888; margin-bottom:5px;">Fecha se perder % do valor:</div>
                <input type="number" id="slTradePercent" value="50" step="5" min="5" max="100" style="color:var(--cyber-red)" onchange="saveState()">
            </div>
            
            <div style="margin-top:auto; font-size:1rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <div class="status-row" style="display:flex; justify-content:space-between;"><span>RSI (14)</span><span id="rsiVal" style="font-weight:bold; color:var(--cyber-blue);">--</span></div>
            </div>
        </div>
        
        <!-- MAIN STAGE -->
        <div class="main-stage">
            <div class="chart-wrapper" id="chartContainer">
                <div id="tvChart"></div>
                <div class="jarvis-container" id="jarvisAnim">
                    <div class="energy-wave"></div>
                    <div class="neon-ring"></div>
                    <img src="jarvis.gif" class="jarvis-img" style="width:100px; height:100px;" onerror="this.style.display='none'">
                </div>
                <div class="live-price" id="priceTag" style="position:absolute; right:10px; top:10px; font-size:1.5rem; font-weight:bold; z-index:5;">--.--</div>
                <div class="result-overlay" id="resultBig">CALL</div>
            </div>
            
            <button class="btn-decode" id="btnDecode" onclick="runAI('MANUAL')">
                <span>DECODIFICAR MERCADO</span>
                <span id="btnSubText" style="font-size:0.9rem; color:var(--cyber-green); margin-top:8px; text-shadow:0 0 10px var(--cyber-green); letter-spacing:2px; font-weight:700;">SISTEMA ONLINE</span>
            </button>
            
            <div class="action-grid">
                <button class="btn-action btn-call" id="btnCall" onclick="placeTrade('CALL')" disabled>COMPRAR ‚¨Ü</button>
                <button class="btn-action btn-put" id="btnPut" onclick="placeTrade('PUT')" disabled>VENDER ‚¨á</button>
            </div>
            
            <div class="positions-wrapper">
                <div class="op-header">
                    <span style="font-size:1rem; font-weight:bold; letter-spacing:1px;">LUCRO ABERTO: <span id="openPL" style="color:#fff;">0.00</span></span>
                    <button onclick="closeAllPositions()" style="background:var(--cyber-red); border:none; color:white; font-weight:bold; cursor:pointer; padding:6px 15px; font-size:0.8rem; border-radius:2px; letter-spacing:1px;">FECHAR TUDO</button>
                </div>
                <!-- SCROLL CONTAINER -->
                <div class="table-scroll">
                    <table class="pos-table">
                        <thead>
                            <tr>
                                <th>HORA</th>
                                <th>TIPO</th>
                                <th>ENTRADA</th>
                                <th>ATUAL</th>
                                <th>TIMER</th>
                                <th>LUCRO</th>
                                <th>A√á√ÉO</th>
                            </tr>
                        </thead>
                        <tbody id="posList">
                            <!-- Rows will be injected here -->
                        </tbody>
                    </table>
                    <div id="emptyMsg" style="text-align:center; color:#445566; padding:30px; font-style:italic;">AGUARDANDO OPERA√á√ïES...</div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT SIDEBAR -->
        <div class="sidebar-right">
            <div style="background:rgba(255,255,255,0.02); padding:20px; border-radius:4px; text-align:center; border:1px solid rgba(255,255,255,0.05); flex-shrink:0;">
                <div style="font-size:0.8rem; color:#8899a6; letter-spacing:3px; font-weight:bold;">RESULTADO DO DIA</div>
                <div id="sessionPL" style="font-size:3rem; font-weight:900; margin-top:5px; color:white; text-shadow:0 0 30px rgba(255,255,255,0.2);">0.00</div>
            </div>
            
            <div class="config-group" style="margin-top:10px; border-color:rgba(255,0,60,0.3); flex-shrink:0;">
                <span class="label-sm" style="color:var(--cyber-red)">STOP LOSS (DI√ÅRIO)</span>
                <input type="number" id="slInput" value="50.00" style="color:var(--cyber-red)" step="1" onchange="saveState()">
            </div>
             <div class="config-group" style="border-color:rgba(0,255,65,0.3); flex-shrink:0;">
                <span class="label-sm" style="color:var(--cyber-green)">META DE LUCRO (DI√ÅRIA)</span>
                <input type="number" id="tpInput" value="50.00" style="color:var(--cyber-green)" step="1" onchange="saveState()">
            </div>

            <div style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-top:20px; flex-shrink:0;">
                <span class="label-sm">HIST√ìRICO RECENTE</span>
            </div>
            <!-- SCROLLABLE HISTORY -->
            <div id="histList" style="flex:1; overflow-y:auto; padding-right:5px; min-height:100px;">
                <div style="text-align:center; color:#445566; font-size:0.8rem; margin-top:40px;">Hist√≥rico vazio.</div>
            </div>
            
            <button onclick="fullLogout()" style="background:transparent; border:1px solid #2a3b55; color:#5f7e97; padding:15px; cursor:pointer; width:100%; border-radius:2px; font-weight:bold; transition:0.2s; letter-spacing:2px; text-transform:uppercase; flex-shrink:0;">Encerrar Sess√£o</button>
        </div>
    </div>
    
    <button id="hardResetBtn" onclick="fullLogout()">HARD RESET</button>

<script>
    // --- HELPER DE SEGURAN√áA ---
    function getEl(id) {
        const el = document.getElementById(id);
        if (!el) {
            console.warn(`CRITICAL: Elemento #${id} n√£o encontrado! Criando dummy...`);
            return document.createElement('div');
        }
        return el;
    }

    // --- GLOBAL ERROR HANDLER ---
    window.onerror = function(msg, url, line) {
        if(localStorage.getItem('crash_loop_guard')) return;
        localStorage.setItem('crash_loop_guard', 'true');
        alert("RECUPERA√á√ÉO DE FALHA V21.3:\\n" + msg);
        localStorage.removeItem('jarvis_accounts');
        setTimeout(() => {
            localStorage.removeItem('crash_loop_guard');
            location.reload(true);
        }, 500);
        return true;
    };

    const APP_ID = 114062; 
    const SYMBOL = "R_100"; 
    const MAX_TRADES = 1; 
    const ANALYSIS_INTERVAL = 1000; 
    

    
    let ws;
    let chart, series;
    let candles = [];
    let model = null;
    let isProcessing = false;
    let availableAccounts = [];
    let currentToken = "";
    let positions = new Map();
    let sessionProfit = 0.0;
    let lastAnalysisTime = 0;
    let lastStrategy = "AI"; 
    let strategyMap = new Map();
    let lastCandleTime = 0; 
    let lastTradeCandleTime = 0; // V21.18: Strict 1-Trade-Per-Candle

    // V21.3 HYPER AGGRESSIVE RECOVERY
    let martingaleLevel = 0;
    let currentStake = 1.0;
    const MAX_MARTINGALE_LEVELS = 8; 
    const MARTINGALE_FACTOR = 2.1;

    // BOOT
    window.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Loaded. Iniciando Jarvis V21.3 Command Center...");
        try {
            checkAuth();
            loadState(); 
            setInterval(updateTimers, 1000); 
        } catch(e) {
            console.error("Boot Error:", e);
            getEl('loginOverlay').style.display = 'flex';
        }
    });

    // --- STATE PERSISTENCE ---
    function saveState() {
        const state = {
            autoTrade: getEl('autoTradeToggle').checked,
            stake: getEl('stakeInput').value,
            duration: getEl('durationSelect').value,
            scalpPercent: getEl('scalpPercent').value,
            slTradePercent: getEl('slTradePercent').value,
            tp: getEl('tpInput').value,
            sl: getEl('slInput').value,
            sessionPL: sessionProfit,
            history: getEl('histList').innerHTML,
            martingaleLevel: martingaleLevel, 
            currentStake: currentStake
        };
        localStorage.setItem('jarvis_state_v20', JSON.stringify(state));
    }

    function loadState() {
        const saved = localStorage.getItem('jarvis_state_v20');
        if (saved) {
            try {
                const state = JSON.parse(saved);
                getEl('autoTradeToggle').checked = state.autoTrade;
                getEl('stakeInput').value = state.stake;
                getEl('durationSelect').value = state.duration;
                if(state.scalpPercent) getEl('scalpPercent').value = state.scalpPercent;
                if(state.slTradePercent) getEl('slTradePercent').value = state.slTradePercent;
                getEl('tpInput').value = state.tp;
                getEl('slInput').value = state.sl;
                sessionProfit = state.sessionPL || 0;
                getEl('sessionPL').innerText = sessionProfit.toFixed(2);
                getEl('sessionPL').style.color = sessionProfit >= 0 ? "#00ff41" : "#ff003c";
                if(state.history) getEl('histList').innerHTML = state.history;
                
                martingaleLevel = state.martingaleLevel || 0;
                currentStake = state.currentStake || parseFloat(state.stake);
            } catch(e) {
                console.warn("Erro ao carregar cache:", e);
            }
        }
    }

    function connectDeriv() {
        window.location.href = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&l=PT&brand=deriv`;
    }

    function checkAuth() {
        const p = new URLSearchParams(window.location.search);
        if (p.has('token1')) {
            let i = 1;
            let accs = [];
            while (p.has(`token${i}`)) {
                accs.push({ 
                    token: p.get(`token${i}`), 
                    id: p.get(`acct${i}`), 
                    currency: p.get(`cur${i}`), 
                    type: p.get(`acct${i}`).startsWith('V') ? 'DEMO' : 'REAL' 
                });
                i++;
            }
            localStorage.setItem('jarvis_accounts', JSON.stringify(accs));
            window.history.replaceState({}, document.title, window.location.pathname);
            availableAccounts = accs;
            currentToken = accs[0].token;
            initSystem();
        } else {
            const saved = localStorage.getItem('jarvis_accounts');
            if (saved) {
                try {
                    availableAccounts = JSON.parse(saved);
                    if (Array.isArray(availableAccounts) && availableAccounts.length > 0) {
                        currentToken = availableAccounts[0].token;
                        initSystem();
                    } else {
                        throw new Error("Dados inv√°lidos");
                    }
                } catch(e) {
                    localStorage.removeItem('jarvis_accounts');
                    getEl('loginOverlay').style.display = 'flex';
                }
            } else {
                getEl('loginOverlay').style.display = 'flex';
            }
        }
    }

    function initSystem() {
        console.log("DEBUG: initSystem CALLED");
        getEl('loginOverlay').style.display = 'none';
        getEl('mainUI').style.display = 'grid'; // Enable Grid
        // No resizeApp call strictly needed now, but keeping listener safe
        setTimeout(() => {
            initChart();
            loadAI();
            connectWS();
        }, 100);
    }

    function fullLogout() {
        localStorage.removeItem('jarvis_accounts');
        localStorage.removeItem('jarvis_state_v20'); 
        location.href = location.pathname;
    }

    function switchAccount() {
        if (!availableAccounts.length) return;
        const currIdx = availableAccounts.findIndex(a => a.token === currentToken);
        const nextIdx = (currIdx + 1) % availableAccounts.length;
        const nextAcc = availableAccounts[nextIdx];
        currentToken = nextAcc.token;
        if(ws) ws.close();
        getEl('accBadge').innerText = "TROCANDO...";
        setTimeout(connectWS, 500);
    }

    function updateAccountUI(info) {
        const badge = getEl('accBadge');
        const isDemo = info.fullname.includes('Virtual') || info.loginid.startsWith('VRTC');
        if(isDemo) {
            badge.innerText = `MODO TREINO (DEMO)`;
            badge.className = "account-badge is-demo";
        } else {
            badge.innerText = `CONTA REAL (${info.currency})`;
            badge.className = "account-badge is-real";
        }
        getEl('btnCall').disabled = false;
        getEl('btnPut').disabled = false;
        getEl('btnCall').classList.add('btn-ready');
        getEl('btnPut').classList.add('btn-ready');
    }

    function initChart() {
        const el = getEl('tvChart');
        const container = getEl('chartContainer');
        
        el.innerHTML = '';
        chart = LightweightCharts.createChart(el, {
            width: container.clientWidth, 
            height: container.clientHeight,
            layout: { backgroundColor: '#050a14', textColor: '#5f7e97' },
            grid: { vertLines: { color: '#1a2639'}, horzLines: { color: '#1a2639'} },
            timeScale: { timeVisible: true, secondsVisible: true }
        });
        series = chart.addCandlestickSeries({
            upColor: '#00ff41', downColor: '#ff003c', 
            borderVisible: false, wickUpColor: '#00ff41', wickDownColor: '#ff003c'
        });
        
        // RESPONSIVE CHART
        new ResizeObserver(entries => {
            if (entries.length === 0 || !entries[0].contentRect) return;
            const { width, height } = entries[0].contentRect;
            chart.resize(width, height);
        }).observe(container);
    }

    function connectWS() {
        console.log("DEBUG: connectWS CALLED");
        ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);
        ws.onopen = () => { 
            console.log("DEBUG: WS OPEN");
            ws.send(JSON.stringify({ authorize: currentToken })); 
        };
        ws.onmessage = (msg) => {
            const data = JSON.parse(msg.data);
            
            if (data.error) {
                // V21.9: Suppress "Resale not offered" error
                if (data.error.code === 'InvalidContractProposal' || data.error.message.includes("Resale of this contract is not offered")) {
                    console.warn("Ignored Error (Resale):", data.error.message);
                    return; 
                }
                console.error("Deriv Error:", data.error);
                alert("ERRO DERIV: " + data.error.message); 
                return;
            }

            if (data.msg_type === 'authorize') {
                updateAccountUI(data.authorize);
                ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
                ws.send(JSON.stringify({ ticks_history: SYMBOL, adjust_start_time: 1, count: 300, end: 'latest', style: 'candles', granularity: 60, subscribe: 1 }));
                ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
            }
            if (data.msg_type === 'balance') getEl('balanceVal').innerText = data.balance.balance + " " + data.balance.currency;
            if (data.msg_type === 'ohlc') {
                const c = data.ohlc;
                updateCandles({ time: c.open_time, open: +c.open, high: +c.high, low: +c.low, close: +c.close });
            }
            if (data.msg_type === 'candles') {
                candles = data.candles.map(c => ({ time: c.epoch, open: +c.open, high: +c.high, low: +c.low, close: +c.close }));
                if(series) series.setData(candles);
            }
            if (data.msg_type === 'proposal') {
                if (data.proposal.id) ws.send(JSON.stringify({ buy: data.proposal.id, price: data.proposal.ask_price }));
            }
            if (data.msg_type === 'buy') {
                strategyMap.set(data.buy.contract_id, lastStrategy);
            }
            if (data.msg_type === 'proposal_open_contract') handlePosition(data.proposal_open_contract);
        };
    }

    function updateCandles(candle) {
        if (candles.length > 0 && candles[candles.length - 1].time === candle.time) {
            candles[candles.length - 1] = candle;
        } else { 
            candles.push(candle); 
            if(candles.length > 300) candles.shift(); 
            lastCandleTime = candle.time; // V21.13: Track new candle
        }
        if(series) series.update(candle);
        
        const priceEl = getEl('priceTag');
        priceEl.innerText = candle.close;
        priceEl.style.color = candle.close >= candle.open ? '#00ff41' : '#ff003c';
        updateRSI();

        // V21.14: CONTINUOUS ANALYSIS (with smart throttling)
        const now = Date.now();
        if (getEl('autoTradeToggle').checked && !isProcessing && (now - lastAnalysisTime > 2000)) {
            lastAnalysisTime = now;
            runAI('AUTO');
        }
    }

    function updateRSI() {
        if(candles.length < 15) return;
        const period = 14;
        let gains = 0, losses = 0;
        const closes = candles.slice(-period-1).map(x=>x.close);
        for(let i=1; i<=period; i++) {
            const diff = closes[i] - closes[i-1];
            if(diff >= 0) gains += diff; else losses -= diff;
        }
        const rs = gains / (losses || 1);
        const rsi = 100 - (100 / (1 + rs));
        getEl('rsiVal').innerText = rsi.toFixed(1);
    }

    function calculateEMA(period) {
        if (candles.length < period) return null;
        const k = 2 / (period + 1);
        let ema = candles[0].close;
        for (let i = 1; i < candles.length; i++) {
            ema = candles[i].close * k + ema * (1 - k);
        }
        return ema;
    }
    
    // V21.11: VOLATILITY CALCULATION
    function calculateVolatility(period = 20) {
        if (candles.length < period) return 0;
        const slice = candles.slice(-period).map(c => c.close);
        const mean = slice.reduce((a,b) => a+b) / period;
        const variance = slice.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / period;
        return Math.sqrt(variance);
    }

    // V21.18: INDICATORS
    function calculateBollinger(period = 20, stdDev = 2) {
        if (candles.length < period) return null;
        const slice = candles.slice(-period).map(c => c.close);
        const mean = slice.reduce((a,b) => a+b) / period;
        const variance = slice.reduce((a,b) => a + Math.pow(b - mean, 2), 0) / period;
        const std = Math.sqrt(variance);
        return { upper: mean + (std * stdDev), lower: mean - (std * stdDev), basis: mean };
    }

    function calculateSupportResistance(period = 500) {
        if (candles.length < 50) return null;
        const lookback = Math.min(candles.length, period);
        const slice = candles.slice(-lookback);
        const highs = slice.map(c => c.high);
        const lows = slice.map(c => c.low);
        return { 
            resistance: Math.max(...highs), 
            support: Math.min(...lows) 
        };
    }

    function calculateTrend(period = 50) {
        if (candles.length < period) return "NEUTRAL";
        const slice = candles.slice(-period);
        // Simple linear regression slope simulation
        const first = slice[0].close;
        const last = slice[slice.length-1].close;
        const change = ((last - first) / first) * 100;
        // V21.21: Increased Sensitivity (0.5 -> 0.1) to catch micro-trends
        if (change > 0.1) return "STRONG_UP";
        if (change < -0.1) return "STRONG_DOWN";
        return "NEUTRAL";
    }

    async function loadAI() {
        console.log("Carregando IA...");
        try {
            model = await tf.loadLayersModel('brain/titan.json');
            const dummy = tf.zeros([1, 60, 1]);
            model.predict(dummy).dispose();
            console.log("IA Online");
        } catch (e) {
            console.error("Erro IA:", e);
        }
    }

    async function runAI(source = 'MANUAL') {
        if (isProcessing) return;
        
        // V21.13: TRADE COOLDOWN - No analysis while position is open
        if (positions.size > 0 && source === 'AUTO') {
            return; // Silent block for AUTO mode
        }
        
        const btn = getEl('btnDecode');
        const sub = getEl('btnSubText');
        const jarvisContainer = getEl('jarvisAnim');
        const originalSubText = sub.innerText;

        if (candles.length < 30) { 
            if(source === 'MANUAL') {
                sub.innerText = "AGUARDANDO DADOS...";
            }
            return;
        }
        try {
            const dailyPL = parseFloat(getEl('sessionPL').innerText);
            const slInput = parseFloat(getEl('slInput').value);
            const stopLossLimit = -Math.abs(slInput); 
            const takeProfit = parseFloat(getEl('tpInput').value);

            if (dailyPL <= stopLossLimit) throw new Error("STOP LOSS DI√ÅRIO ATINGIDO");
            if (dailyPL >= takeProfit) throw new Error("META BATIDA! PARAB√âNS");

            // V21.18: STRICT SAFETY - One Trade Per Candle
            const currentCandleTime = candles[candles.length - 1].time;
            if (source === 'AUTO' && lastTradeCandleTime === currentCandleTime) {
                // Already traded this candle
                isProcessing = false;
                resetBtn();
                return;
            }

            let signal = "NEUTRO";
            let currentStrategy = "HYBRID";

            // V21.4: MARTINGALE STATUS (SHOW LIMIT)
            if (martingaleLevel > 0) {
                sub.innerText = `MODO RECUPERA√á√ÉO (N√çVEL ${martingaleLevel}/${MAX_MARTINGALE_LEVELS})`;
                sub.style.color = "var(--cyber-red)";
            }
            
            // --- V21.18: ADVANCED INDICATORS ---
            const bb = calculateBollinger(20, 2.5); // 2.5 StdDev (Strict)
            const sr = calculateSupportResistance(500); // 500 Candles lookback
            const trend = calculateTrend(50); // Linear Regression Slope
            
            const price = candles[candles.length - 1].close;
            
            // LOGIC: REVERSAL AT EXTREMES
            // CALL: Price < Lower Band AND Price near Support
            // PUT: Price > Upper Band AND Price near Resistance
            
            // V21.19: HYBRID LOGIC
            // 1. REVERSAL: Bollinger + RSI Extremes
            // 2. MOMENTUM: Strong Trend + Safe RSI
            
            const rsi = parseFloat(getEl('rsiVal').innerText);
            
            // DEBUG LOGS (REMOVE LATER)
            console.log(`ANALYSIS: Price=${price} | RSI=${rsi} | Trend=${trend} | BB_Lower=${bb?.lower.toFixed(2)} | BB_Upper=${bb?.upper.toFixed(2)}`);

            if (bb) {
                const price = candles[candles.length - 1].close;
                
                // --- STRATEGY 1: REVERSAL (Contra-Trend) ---
                // "Esticou demais, vai voltar"
                // V21.20: Relaxed RSI (30/70) for Reversal to test entry
                if (price <= bb.lower && rsi < 30) { 
                    signal = "CALL"; 
                    sub.innerText = `REVERSAL: FUNDO BOLINGER (RSI ${rsi})`;
                }
                else if (price >= bb.upper && rsi > 70) { 
                    signal = "PUT"; 
                    sub.innerText = `REVERSAL: TOPO BOLINGER (RSI ${rsi})`;
                }
                
                // --- STRATEGY 2: MOMENTUM (Trend Following) ---
                // "Tend√™ncia forte, vai continuar"
                else if (trend === "STRONG_UP" && rsi < 70) {
                    if (price > bb.basis) { // Price above middle band
                        signal = "CALL";
                        sub.innerText = `MOMENTUM: TEND√äNCIA ALTA (RSI ${rsi})`;
                    }
                }
                else if (trend === "STRONG_DOWN" && rsi > 30) {
                    if (price < bb.basis) { // Price below middle band
                        signal = "PUT";
                        sub.innerText = `MOMENTUM: TEND√äNCIA BAIXA (RSI ${rsi})`;
                    }
                }

                // --- STRATEGY 3: NEUTRAL SCALP (The "Unfreezer") ---
                // "Mercado parado? Opera o meio campo"
                else if (trend === "NEUTRAL") {
                    if (price > bb.basis && rsi > 50 && rsi < 70) {
                         signal = "CALL";
                         sub.innerText = `SCALP: MEIO DE BANDA (ALTA)`;
                    }
                    else if (price < bb.basis && rsi < 50 && rsi > 30) {
                         signal = "PUT";
                         sub.innerText = `SCALP: MEIO DE BANDA (BAIXA)`;
                    }
                }
            }
            
            // RECOVERY OVERRIDE (Use AI if stuck)
            if (signal === "NEUTRO" && martingaleLevel > 0) {
                 // Fallback to simple AI for recovery
                 // ... (AI Logic Placeholder if needed, or keep strict)
                 currentStrategy = "RECOVERY_AI";
            }

            // --- CHAMELEON ANIMATION ---
            jarvisContainer.classList.remove('sentiment-bullish', 'sentiment-bearish', 'sentiment-neutral');
            if (signal === "CALL") jarvisContainer.classList.add('sentiment-bullish');
            else if (signal === "PUT") jarvisContainer.classList.add('sentiment-bearish');
            else jarvisContainer.classList.add('sentiment-neutral');

            setTimeout(() => {
                if (signal !== "NEUTRO") {
                    showResult(signal);
                    if(getEl('autoTradeToggle').checked) {
                        if (positions.size >= MAX_TRADES) {
                            sub.innerHTML = `<span style='color:orange'>LIMITE DE ORDENS (${MAX_TRADES}/${MAX_TRADES})</span>`;
                            setTimeout(resetBtn, 2000);
                        } else {
                            if (source === 'AUTO') lastTradeCandleTime = candles[candles.length-1].time; // Mark candle as traded
                            placeTrade(signal, currentStrategy);
                            resetBtn();
                        }
                    } else {
                         resetBtn();
                    }
                } else {
                    resetBtn();
                }
                isProcessing = false;
            }, 1000); 

        } catch(e) { 
            console.log("Analysis Info:", e.message);
            if (source === 'MANUAL') alert(e.message);
            isProcessing = false; 
            resetBtn();
        }

        function resetBtn() {
            btn.style.borderColor = ""; 
            btn.style.boxShadow = "";
            if (martingaleLevel === 0) {
                sub.innerText = "SISTEMA ONLINE"; 
                sub.style.color = "var(--cyber-green)";
            }
        }
    }

    function showResult(text) {
        const el = getEl('resultBig');
        el.innerText = text;
        el.style.color = text === "CALL" ? "#00ff41" : (text === "PUT" ? "#ff003c" : "#fff");
        el.classList.add('show-res');
        setTimeout(() => el.classList.remove('show-res'), 3000);
    }

    function placeTrade(direction, strategy = "AI") {
        const stake = currentStake; 
        const duration = getEl('durationSelect').value;
        const acc = availableAccounts.find(a=>a.token===currentToken);
        
        if(!acc) return;
        
        lastStrategy = strategy; 

        const btn = direction === 'CALL' ? getEl('btnCall') : getEl('btnPut');
        btn.style.filter = "brightness(1.5)";
        setTimeout(() => btn.style.filter = "none", 500);

        ws.send(JSON.stringify({ 
            proposal: 1, 
            amount: stake, 
            basis: 'stake', 
            contract_type: direction, 
            currency: acc.currency, 
            duration: duration, 
            duration_unit: 'm', 
            symbol: SYMBOL 
        }));
    }

    function handlePosition(p) {
        if (!p.buy_price || !p.contract_type) return;

        if (p.is_sold) {
            if (positions.has(p.contract_id)) { 
                const strategy = strategyMap.get(p.contract_id) || "AI";
                positions.delete(p.contract_id); 
                strategyMap.delete(p.contract_id);
                addHistory(p, strategy); 
                ws.send(JSON.stringify({ balance: 1 })); 
            }
        } else {
            // V21.12: Initialize Max Profit Logic
            if (!positions.has(p.contract_id)) {
                p.entryTime = new Date().toLocaleTimeString();
                p.maxProfitUSD = -9999; // Track Max Profit in USD
            } else {
                const existing = positions.get(p.contract_id);
                p.entryTime = existing.entryTime;
                p.maxProfitUSD = existing.maxProfitUSD || -9999;
            }
            
            const profit = Number(p.profit || 0);
            const stake = Number(p.buy_price || 0);
            const profitPercent = (profit / stake) * 100;

            // Track High Water Mark (USD)
            if (profit > p.maxProfitUSD) p.maxProfitUSD = profit;

            positions.set(p.contract_id, p);
            
            const scalpPercent = parseFloat(getEl('scalpPercent').value);
            const slTradePercent = parseFloat(getEl('slTradePercent').value);
            
            if (p.is_valid_to_sell) {
                // V21.17: MICRO-TRAILING MAXIMIZER
                
                // 1. STRICT STOP LOSS (PRIORITY 1)
                if (profitPercent <= -slTradePercent) {
                    console.warn(`‚õî STOP LOSS: ${profitPercent.toFixed(2)}% <= -${slTradePercent}%`);
                    sellPosition(p.contract_id);
                    return; 
                }

                // 2. MICRO-TRAILING TP ($0.01 Retraction)
                if (profitPercent >= scalpPercent) {
                    // Target Met - Monitor Retraction
                    const retractionUSD = p.maxProfitUSD - profit;
                    
                    if (retractionUSD >= 0.01) {
                        // "Retornou 1 centavo" - CLOSE!
                        console.log(`üí∞ MICRO-TRAILING: Lucro ${profit.toFixed(2)} (Pico: ${p.maxProfitUSD.toFixed(2)} | Retra√ß√£o: ${retractionUSD.toFixed(2)})`);
                        sellPosition(p.contract_id);
                    } else {
                         // console.log(`üöÄ SUBINDO: ${profit.toFixed(2)} (Pico: ${p.maxProfitUSD.toFixed(2)})`);
                    }
                }
            }
        }
        renderPositions();
    }

    function sellPosition(id) { ws.send(JSON.stringify({ sell: id, price: 0 })); }
    function closeAllPositions() { positions.forEach((_, id) => sellPosition(id)); }

    function updateTimers() {
        if(positions.size > 0) renderPositions();
    }

    function renderPositions() {
        const list = getEl('posList');
        list.innerHTML = "";
        let total = 0;
        
        if(positions.size === 0) {
            getEl('emptyMsg').style.display = 'block';
        } else {
            getEl('emptyMsg').style.display = 'none';
            
            positions.forEach(p => {
                const profit = Number(p.profit || 0);
                total += profit;
                const cType = p.contract_type ? p.contract_type.toUpperCase() : "ORDEM";
                const entry = p.buy_price || 0;
                const current = (Number(p.buy_price) + Number(p.profit)).toFixed(2);
                
                let timeLeft = "--";
                if (p.date_expiry) {
                    const now = Math.floor(Date.now() / 1000);
                    const diff = p.date_expiry - now;
                    if (diff > 0) {
                        const m = Math.floor(diff / 60);
                        const s = diff % 60;
                        timeLeft = `${m}:${s.toString().padStart(2, '0')}`;
                    } else {
                        timeLeft = "0:00";
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.entryTime || '--'}</td>
                    <td style="color:${cType==='CALL'?'#00ff41':'#ff003c'}">${cType}</td>
                    <td>${entry}</td>
                    <td>${current}</td>
                    <td style="color:var(--cyber-gold)">${timeLeft}</td>
                    <td style="color:${profit>=0?'#00ff41':'#ff003c'}">${profit.toFixed(2)}</td>
                    <td><button onclick="sellPosition(${p.contract_id})" style="background:var(--cyber-red); border:none; color:white; font-weight:bold; cursor:pointer; padding:2px 8px; border-radius:2px;">X</button></td>
                `;
                list.prepend(tr);
            });
        }
        getEl('openPL').innerText = total.toFixed(2);
        getEl('openPL').style.color = total >= 0 ? "#00ff41" : "#ff003c";
    }

    function addHistory(p, strategy = "AI") {
        const profit = Number(p.profit || 0);
        sessionProfit += profit;
        getEl('sessionPL').innerText = sessionProfit.toFixed(2);
        getEl('sessionPL').style.color = sessionProfit >= 0 ? "#00ff41" : "#ff003c";
        
        const baseStake = parseFloat(getEl('stakeInput').value);
        
        if (profit < 0) {
            if (martingaleLevel < MAX_MARTINGALE_LEVELS) {
                martingaleLevel++;
                currentStake = parseFloat((currentStake * MARTINGALE_FACTOR).toFixed(2)); // V21.5: Fix Precision
                console.warn(`LOSS. ATIVANDO MARTINGALE N√çVEL ${martingaleLevel}. NOVA STAKE: ${currentStake.toFixed(2)}`);
            } else {
                console.error("MARTINGALE M√ÅXIMO ATINGIDO. RESETANDO.");
                martingaleLevel = 0;
                currentStake = baseStake;
            }
        } else {
            if (martingaleLevel > 0) {
                console.log("RECUPERA√á√ÉO BEM SUCEDIDA! RESETANDO.");
            }
            martingaleLevel = 0;
            currentStake = baseStake;
        }

        const div = document.createElement('div');
        div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem;";
        div.innerHTML = `<span style="color:${p.contract_type==='CALL'?'#00ff41':'#ff003c'}">${p.contract_type}</span><span style="font-weight:bold; color:${profit>=0?'#00ff41':'#ff003c'}">${profit.toFixed(2)}</span>`;
        const h = getEl('histList');
        if(h.innerText.includes("vazio")) h.innerHTML = "";
        h.prepend(div);
        saveState(); 
    }
</script>
</body>
</html>