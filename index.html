<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>JARVIS COMMAND CENTER V21.5</title>
    <link rel="icon" type="image/jpeg" href="JARVIS ROSTO.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root { 
            --cyber-dark: #050a14;
            --cyber-navy: #0b1221;
            --cyber-blue: #00f3ff;
            --cyber-gold: #ffd700;
            --cyber-red: #ff003c;
            --cyber-green: #00ff41;
            --glass-panel: rgba(11, 18, 33, 0.85);
            --glass-border: 1px solid rgba(0, 243, 255, 0.15);
            --neon-glow: 0 0 10px rgba(0, 243, 255, 0.3);
        }
        
        * { box-sizing: border-box; outline: none; user-select: none; }
        
        body { 
            background: radial-gradient(circle at 50% 50%, #0b1629 0%, #020408 100%);
            color: #e0e6ed; 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }

        /* AUTO-SCALE CONTAINER */
        #appContainer {
            width: 1920px;
            height: 1080px;
            position: absolute;
            transform-origin: center center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* LOGIN OVERLAY */
        #loginOverlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background: rgba(5, 10, 20, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .login-content { 
            text-align: center; 
            padding: 60px; 
            border-radius: 4px; 
            border: 1px solid var(--cyber-blue); 
            background: rgba(0,0,0,0.6); 
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.1); 
            position: relative;
        }
        
        .login-content::before {
            content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(45deg, var(--cyber-blue), transparent, var(--cyber-blue));
            z-index: -1; opacity: 0.3;
        }

        .login-btn { 
            background: transparent; 
            border: 2px solid var(--cyber-blue); 
            color: var(--cyber-blue); 
            padding: 15px 50px; 
            font-size: 1.5rem; 
            font-family: 'Rajdhani'; 
            font-weight: 800; 
            cursor: pointer; 
            transition: 0.3s; 
            text-transform: uppercase; 
            letter-spacing: 4px; 
            margin-top: 30px; 
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover { 
            background: var(--cyber-blue); 
            color: #000; 
            box-shadow: 0 0 30px var(--cyber-blue); 
        }

        /* MAIN INTERFACE */
        .interface-grid { 
            display: none; 
            grid-template-columns: 350px 1fr 350px; 
            width: 100%; 
            height: 100%; 
            background: var(--glass-panel); 
            border: var(--glass-border); 
            border-radius: 4px; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(20px); 
            box-shadow: 0 0 100px rgba(0,0,0,0.8); 
        }
        
        .sidebar-left, .sidebar-right { 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            z-index: 10; 
            background: rgba(0,0,0,0.2); 
        }
        
        .sidebar-left { border-right: var(--glass-border); } 
        .sidebar-right { border-left: var(--glass-border); }
        
        .brand-logo { 
            font-size: 2.5rem; 
            letter-spacing: 8px; 
            color: var(--cyber-blue); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 20px; 
            margin-bottom: 10px; 
            font-weight: 900; 
            text-align: center; 
            text-shadow: 0 0 20px rgba(0, 243, 255, 0.4); 
        }
        
        .brand-subtitle { 
            font-size: 0.8rem; 
            color: #8899a6; 
            letter-spacing: 3px; 
            text-transform: uppercase; 
            margin-top: -15px; 
            margin-bottom: 20px; 
            text-align: center; 
            font-weight: 600; 
        }
        
        /* CONFIG GROUPS */
        .config-group { 
            background: rgba(255,255,255,0.02); 
            padding: 20px; 
            border-radius: 2px; 
            border: 1px solid rgba(255,255,255,0.05); 
            transition: 0.3s;
        }
        .config-group:hover { border-color: rgba(0, 243, 255, 0.3); }
        
        .label-sm { 
            font-size: 0.9rem; 
            color: #5f7e97; 
            letter-spacing: 1px; 
            font-weight: 700; 
            margin-bottom: 10px; 
            display: block; 
            text-transform: uppercase;
        }
        
        input, select { 
            background: #080c14; 
            color: #fff; 
            border: 1px solid #2a3b55; 
            padding: 12px; 
            border-radius: 2px; 
            font-family: 'Rajdhani'; 
            font-size: 1.3rem; 
            font-weight: 700; 
            width: 100%; 
            text-align: center; 
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--cyber-blue); box-shadow: 0 0 15px rgba(0,243,255,0.1); }
        
        /* SWITCHES */
        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #1a2639; transition: .4s; border-radius: 2px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: #5f7e97; transition: .4s; border-radius: 1px; }
        input:checked + .slider { background-color: rgba(0, 255, 65, 0.2); border: 1px solid var(--cyber-green); }
        input:checked + .slider:before { transform: translateX(22px); background-color: var(--cyber-green); }
        
        /* MAIN STAGE */
        .main-stage { 
            padding: 30px; 
            display: flex; 
            flex-direction: column; 
            gap: 25px; 
            position: relative; 
            width: 100%; 
            background: radial-gradient(circle at center, rgba(0, 243, 255, 0.02) 0%, transparent 80%); 
        }
        
        /* CHART */
        .chart-wrapper { 
            height: 45vh; 
            flex-shrink: 0; 
            position: relative; 
            background: #050a14; 
            border: 1px solid #1a2639; 
            border-radius: 2px; 
            overflow: hidden; 
            box-shadow: inset 0 0 100px rgba(0,0,0,0.9); 
        }
        #tvChart { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* JARVIS VISUALS */
        .jarvis-container { 
            position: absolute; top: 20px; left: 20px; width: 160px; height: 160px; z-index: 20; 
            pointer-events: none; display: flex; justify-content: center; align-items: center; 
        }
        
        .jarvis-img { 
            width: 130px; height: 130px; object-fit: cover; border-radius: 50%; 
            position: relative; z-index: 22; background: #000; 
            border: 2px solid rgba(0,243,255,0.3); 
        }
        
        .neon-ring { 
            position: absolute; width: 150px; height: 150px; border-radius: 50%; 
            border: 2px dashed var(--cyber-blue); border-top-color: transparent; border-bottom-color: transparent; 
            z-index: 21; 
            animation: spinSlow 10s linear infinite; 
            box-shadow: 0 0 15px rgba(0,243,255,0.2); 
            transition: all 0.5s ease;
        }
        
        .energy-wave {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 400px; height: 400px; 
            background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%);
            opacity: 0; z-index: 10; pointer-events: none;
            border-radius: 50%;
            animation: wavePulse 2s infinite ease-out;
            transition: background 0.5s ease; 
        }

        .sentiment-bullish .energy-wave { background: radial-gradient(circle, rgba(0, 255, 65, 0.3) 0%, transparent 70%); }
        .sentiment-bullish .neon-ring { border-color: var(--cyber-green); box-shadow: 0 0 20px rgba(0,255,65,0.3); }
        
        .sentiment-bearish .energy-wave { background: radial-gradient(circle, rgba(255, 0, 60, 0.3) 0%, transparent 70%); }
        .sentiment-bearish .neon-ring { border-color: var(--cyber-red); box-shadow: 0 0 20px rgba(255,0,60,0.3); }
        
        .sentiment-neutral .energy-wave { background: radial-gradient(circle, rgba(0, 243, 255, 0.3) 0%, transparent 70%); }
        .sentiment-neutral .neon-ring { border-color: var(--cyber-blue); box-shadow: 0 0 15px rgba(0,243,255,0.2); }

        @keyframes spinSlow { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes wavePulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        /* BUTTONS */
        .btn-decode { 
            width: 100%; padding: 25px; margin-top: 5px; 
            background: linear-gradient(90deg, rgba(0,0,0,0.8), rgba(0, 243, 255, 0.1), rgba(0,0,0,0.8)); 
            border: 1px solid var(--cyber-blue); 
            color: var(--cyber-blue); 
            font-family: 'Rajdhani'; font-size: 2rem; font-weight: 900; 
            letter-spacing: 4px; text-transform: uppercase; 
            cursor: pointer; transition: 0.3s; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            line-height: 1.2; 
            position: relative;
        }
        .btn-decode::after {
            content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px;
            background: var(--cyber-blue); box-shadow: 0 0 20px var(--cyber-blue);
        }
        .btn-decode:hover { background: rgba(0, 243, 255, 0.15); letter-spacing: 6px; }
        
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 80px; }
        .btn-action { 
            font-size: 2.2rem; font-weight: 900; border: none; color: white; 
            cursor: pointer; border-radius: 2px; font-family: 'Rajdhani'; opacity: 0.4; 
            transition: 0.3s; letter-spacing: 2px;
        }
        .btn-call { background: linear-gradient(180deg, #00ff85, #004d26); border-bottom: 4px solid #004d26; }
        .btn-put { background: linear-gradient(180deg, #ff3b6a, #5e0018); border-bottom: 4px solid #5e0018; }
        .btn-ready { opacity: 1; }
        .btn-ready:hover { filter: brightness(1.2); transform: translateY(-2px); }
        
        /* POSITIONS TABLE */
        .positions-wrapper { 
            flex: 1; min-height: 0; 
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.05); 
            border-radius: 2px; display: flex; flex-direction: column; 
        }
        .op-header { 
            padding: 15px; background: rgba(255,255,255,0.02); 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .pos-table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        .pos-table th { text-align: left; padding: 10px; color: #5f7e97; font-weight: 700; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .pos-table td { padding: 10px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: 600; }
        .pos-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .result-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); font-size: 8rem; font-weight: 900; z-index: 30; opacity: 0; transition: all 0.4s; text-shadow: 0 0 50px currentColor; pointer-events: none; }
        .show-res { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        
        /* ACCOUNT BADGE */
        .account-badge { 
            background: rgba(0,0,0,0.4); color: #fff; padding: 20px; text-align: center; 
            border-radius: 2px; border: 1px solid #333; font-weight: 800; 
            cursor: pointer; transition: 0.3s; margin-bottom: 20px; 
            user-select: none; letter-spacing: 2px; font-size: 1rem;
        }
        .account-badge:hover { border-color: var(--cyber-blue); color: var(--cyber-blue); box-shadow: 0 0 20px rgba(0,243,255,0.1); }
        .is-demo { color: var(--cyber-gold); border-color: rgba(255, 215, 0, 0.3); }
        .is-real { color: var(--cyber-green); border-color: rgba(0, 255, 65, 0.3); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050a14; }
        ::-webkit-scrollbar-thumb { background: #2a3b55; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--cyber-blue); }

        #hardResetBtn { position: fixed; bottom: 10px; right: 10px; z-index: 10000; background: var(--cyber-red); color: white; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; opacity: 0.3; }
            if (signal === "NEUTRO") {
                currentStrategy = "MOMENTUM";
                const ema9 = calculateEMA(9);
                const currentPrice = candles[candles.length-1].close;
                const openPrice = candles[candles.length-1].open;
                const rsi = parseFloat(getEl('rsiVal').innerText);
                
                if (ema9) {
                    const isGreen = currentPrice > openPrice;
                    const isRed = currentPrice < openPrice;
                    
                    // V21.5: PURE AI RECOVERY (NO RSI)
                    let rsiCall = 65;
                    let rsiPut = 35;
                    
                    if (martingaleLevel > 0) {
                        rsiCall = 101; // Impossible to block
                        rsiPut = -1;   // Impossible to block
                    }

                    if (currentPrice > ema9 && isGreen && rsi < rsiCall) signal = "CALL";
                    else if (currentPrice < ema9 && isRed && rsi > rsiPut) signal = "PUT";
                }
            }

            // --- CHAMELEON ANIMATION ---
            jarvisContainer.classList.remove('sentiment-bullish', 'sentiment-bearish', 'sentiment-neutral');
            if (signal === "CALL") jarvisContainer.classList.add('sentiment-bullish');
            else if (signal === "PUT") jarvisContainer.classList.add('sentiment-bearish');
            else jarvisContainer.classList.add('sentiment-neutral');

            setTimeout(() => {
                if (signal !== "NEUTRO") {
                    showResult(signal);
                    if(getEl('autoTradeToggle').checked) {
                        if (positions.size >= MAX_TRADES) {
                            sub.innerHTML = `<span style='color:orange'>LIMITE DE ORDENS (${MAX_TRADES}/${MAX_TRADES})</span>`;
                            setTimeout(resetBtn, 2000);
                        } else {
                            placeTrade(signal, currentStrategy);
                            resetBtn();
                        }
                    } else {
                         resetBtn();
                    }
                } else {
                    resetBtn();
                }
                isProcessing = false;
            }, 1000); 

        } catch(e) { 
            console.log("Analysis Info:", e.message);
            if (source === 'MANUAL') alert(e.message);
            isProcessing = false; 
            resetBtn();
        }

        function resetBtn() {
            btn.style.borderColor = ""; 
            btn.style.boxShadow = "";
            if (martingaleLevel === 0) {
                sub.innerText = "SISTEMA ONLINE"; 
                sub.style.color = "var(--cyber-green)";
            }
        }
    }

    function showResult(text) {
        const el = getEl('resultBig');
        el.innerText = text;
        el.style.color = text === "CALL" ? "#00ff41" : (text === "PUT" ? "#ff003c" : "#fff");
        el.classList.add('show-res');
        setTimeout(() => el.classList.remove('show-res'), 3000);
    }

    function placeTrade(direction, strategy = "AI") {
        const stake = currentStake; 
        const duration = getEl('durationSelect').value;
        const acc = availableAccounts.find(a=>a.token===currentToken);
        
        if(!acc) return;
        
        lastStrategy = strategy; 

        const btn = direction === 'CALL' ? getEl('btnCall') : getEl('btnPut');
        btn.style.filter = "brightness(1.5)";
        setTimeout(() => btn.style.filter = "none", 500);

        ws.send(JSON.stringify({ 
            proposal: 1, 
            amount: stake, 
            basis: 'stake', 
            contract_type: direction, 
            currency: acc.currency, 
            duration: duration, 
            duration_unit: 'm', 
            symbol: SYMBOL 
        }));
    }

    function handlePosition(p) {
        if (!p.buy_price || !p.contract_type) return;

        if (p.is_sold) {
            if (positions.has(p.contract_id)) { 
                const strategy = strategyMap.get(p.contract_id) || "AI";
                positions.delete(p.contract_id); 
                strategyMap.delete(p.contract_id);
                addHistory(p, strategy); 
                ws.send(JSON.stringify({ balance: 1 })); 
            }
        } else {
            if (!positions.has(p.contract_id)) {
                p.entryTime = new Date().toLocaleTimeString();
            } else {
                p.entryTime = positions.get(p.contract_id).entryTime;
            }
            
            positions.set(p.contract_id, p);
            const profit = Number(p.profit || 0);
            const stake = Number(p.buy_price || 0);
            const profitPercent = (profit / stake) * 100;
            
            const scalpPercent = parseFloat(getEl('scalpPercent').value);
            const slTradePercent = parseFloat(getEl('slTradePercent').value);
            
            if (p.is_valid_to_sell) {
                if (profitPercent >= scalpPercent) {
                    console.log(`SCALPING: Alvo atingido (+${profitPercent.toFixed(2)}%). Fechando...`);
                    sellPosition(p.contract_id);
                }
                if (profitPercent <= -slTradePercent) {
                    console.log(`STOP LOSS: Limite atingido (-${profitPercent.toFixed(2)}%). Fechando...`);
                    sellPosition(p.contract_id);
                }
            }
        }
        renderPositions();
    }

    function sellPosition(id) { ws.send(JSON.stringify({ sell: id, price: 0 })); }
    function closeAllPositions() { positions.forEach((_, id) => sellPosition(id)); }

    function updateTimers() {
        if(positions.size > 0) renderPositions();
    }

    function renderPositions() {
        const list = getEl('posList');
        list.innerHTML = "";
        let total = 0;
        
        if(positions.size === 0) {
            getEl('emptyMsg').style.display = 'block';
        } else {
            getEl('emptyMsg').style.display = 'none';
            
            positions.forEach(p => {
                const profit = Number(p.profit || 0);
                total += profit;
                const cType = p.contract_type ? p.contract_type.toUpperCase() : "ORDEM";
                const entry = p.buy_price || 0;
                const current = (Number(p.buy_price) + Number(p.profit)).toFixed(2);
                
                let timeLeft = "--";
                if (p.date_expiry) {
                    const now = Math.floor(Date.now() / 1000);
                    const diff = p.date_expiry - now;
                    if (diff > 0) {
                        const m = Math.floor(diff / 60);
                        const s = diff % 60;
                        timeLeft = `${m}:${s.toString().padStart(2, '0')}`;
                    } else {
                        timeLeft = "0:00";
                    }
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${p.entryTime || '--'}</td>
                    <td style="color:${cType==='CALL'?'#00ff41':'#ff003c'}">${cType}</td>
                    <td>${entry}</td>
                    <td>${current}</td>
                    <td style="color:var(--cyber-gold)">${timeLeft}</td>
                    <td style="color:${profit>=0?'#00ff41':'#ff003c'}">${profit.toFixed(2)}</td>
                    <td><button onclick="sellPosition(${p.contract_id})" style="background:var(--cyber-red); border:none; color:white; font-weight:bold; cursor:pointer; padding:2px 8px; border-radius:2px;">X</button></td>
                `;
                list.prepend(tr);
            });
        }
        getEl('openPL').innerText = total.toFixed(2);
        getEl('openPL').style.color = total >= 0 ? "#00ff41" : "#ff003c";
    }

    function addHistory(p, strategy = "AI") {
        const profit = Number(p.profit || 0);
        sessionProfit += profit;
        getEl('sessionPL').innerText = sessionProfit.toFixed(2);
        getEl('sessionPL').style.color = sessionProfit >= 0 ? "#00ff41" : "#ff003c";
        
        const baseStake = parseFloat(getEl('stakeInput').value);
        
        if (profit < 0) {
            if (martingaleLevel < MAX_MARTINGALE_LEVELS) {
                martingaleLevel++;
                currentStake = parseFloat((currentStake * MARTINGALE_FACTOR).toFixed(2)); // V21.5: Fix Precision
                console.warn(`LOSS. ATIVANDO MARTINGALE NÍVEL ${martingaleLevel}. NOVA STAKE: ${currentStake.toFixed(2)}`);
            } else {
                console.error("MARTINGALE MÁXIMO ATINGIDO. RESETANDO.");
                martingaleLevel = 0;
                currentStake = baseStake;
            }
        } else {
            if (martingaleLevel > 0) {
                console.log("RECUPERAÇÃO BEM SUCEDIDA! RESETANDO.");
            }
            martingaleLevel = 0;
            currentStake = baseStake;
        }

        const div = document.createElement('div');
        div.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem;";
        div.innerHTML = `<span style="color:${p.contract_type==='CALL'?'#00ff41':'#ff003c'}">${p.contract_type}</span><span style="font-weight:bold; color:${profit>=0?'#00ff41':'#ff003c'}">${profit.toFixed(2)}</span>`;
        const h = getEl('histList');
        if(h.innerText.includes("vazio")) h.innerHTML = "";
        h.prepend(div);
        saveState(); 
    }
</script>
</body>
</html>